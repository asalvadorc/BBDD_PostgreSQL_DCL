# üß™ PR√ÅCTICA: Gesti√≥n de usuarios, roles y permisos en PostgreSQL

**Objetivo**{.azul}

Crear una base de datos, un esquema propio, roles y usuarios. Asignar permisos siguiendo el
modelo de m√≠nimo privilegio y comprobar accesos.

En esta pr√°ctica aprender√°s a:

- Crear una base de datos
- Crear un esquema propio
- Crear roles (grupos de permisos)
- Crear usuarios
- Asignar permisos correctamente
- Comprobar qu√© puede hacer cada usuario

Trabajaremos aplicando el modelo de **m√≠nimo privilegio**:  
cada usuario solo tendr√° los permisos necesarios para su funci√≥n.

---

**Base de Datos**{.azul}

Una empresa quiere gestionar su stock y sus ventas.

Se deber√° crear:

- Base de datos: **tienda**{.verde}
- Esquema propio: **app**{.verde}
- Tablas:
    - **productos**{.verde}
    - **ventas**{.verde}

Adem√°s existir√°n distintos tipos de usuarios:

- Usuario de consulta
- Usuario de almac√©n
- Usuario TPV (cajas)
- Usuario administrador

---

**1.  Crear la base de datos**

Crea una base de datos llamada: **tienda**{.verde} y con√©ctate a ella.


**2. Crear un esquema propio**

En lugar de usar el esquema public, crea uno llamado: **app**{.verde}

**3. Bloquea el esquema public**

Evita que los usuarios creen objetos en el esquema por defecto.

Revoca el permiso de creaci√≥n sobre public.

**4. Crear las tablas**

Dentro del esquema app, crea:

Tabla **productos**{.verde}

- id (clave primaria)
- nombre
- stock

Tabla **ventas**{.verde}

- id (clave primaria)
- producto_id (relacionado con productos)
- unidades

Inserta al menos dos productos de prueba.

**5. Crear roles**

Crea los siguientes roles:

- rol_consulta
- rol_almacen
- rol_tpvs
- rol_admin

**6. Dar acceso al esquema**

Todos los roles deben poder usar el esquema app.

**7. Asignar permisos**

Asigna los siguientes permisos:

- rol_consulta: Solo puede consultar productos
- rol_almacen: Puede consultar productos y Puede actualizar stock
- rol_tpvs: Puede consultar productos y Puede insertar ventas
- rol_admin: Puede hacer cualquier operaci√≥n

**8. Permisos sobre secuencias**

Los roles que insertan datos deben tener acceso a las secuencias del esquema.

**9. Crear usuarios**

Crea los siguientes usuarios:

- user_consulta
- user_almacen
- user_tpvs
- user_admin

**10. Asignar roles a usuarios**

Cada usuario debe recibir su rol correspondiente.

**11. Pruebas**

Comprueba qu√© puede hacer cada usuario:

| Usuario        | SELECT | UPDATE | INSERT |
|---------------|--------|--------|--------|
| user_consulta | ‚úîÔ∏è     | ‚ùå     | ‚ùå     |
| user_almacen  | ‚úîÔ∏è     | ‚úîÔ∏è     | ‚ùå     |
| user_tpvs     | ‚úîÔ∏è     | ‚ùå     | ‚úîÔ∏è     |
| user_admin    | ‚úîÔ∏è     | ‚úîÔ∏è     | ‚úîÔ∏è     |


**12. Revocar permisos**

Quita el rol de almac√©n a: user_almacen


Vuelve a comprobar si puede modificar el stock.

**13. Preguntas**

Responde:

¬øPor qu√© es mejor usar un esquema propio que public?

¬øQu√© ventaja tiene usar roles?

¬øQu√© significa m√≠nimo privilegio?

¬øQu√© ocurre si no damos permiso de uso del esquema?

üìå Entrega

Debes entregar:

Script SQL

Resultado de las pruebas

Respuestas a las preguntas

_____________

[Descargar soluci√≥n comandos psql](solucion_practica_dcl_psql.sql)

-- =========================================================  
-- PR√ÅCTICA DCL POSTGRESQL (SOLUCI√ìN)  
-- BD: tienda | Esquema: app  
-- =========================================================

-- 1) Crear base de datos
CREATE DATABASE tienda;

-- Conectarse a la BD (en psql)
-- \c tienda

-- 2) Crear esquema propio
CREATE SCHEMA app;

-- 3) Bloquear creaci√≥n en public (buena pr√°ctica)
REVOKE CREATE ON SCHEMA public FROM PUBLIC;

-- 4) Crear tablas en el esquema app
CREATE TABLE app.productos (
    id SERIAL PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    stock INT NOT NULL DEFAULT 0
);

CREATE TABLE app.ventas (
    id SERIAL PRIMARY KEY,
    producto_id INT NOT NULL REFERENCES app.productos(id),
    unidades INT NOT NULL,
    fecha TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Datos de prueba
INSERT INTO app.productos (nombre, stock) VALUES
('Teclado', 20),
('Raton', 15);

-- 5) Crear roles (grupos)
CREATE ROLE rol_consulta;
CREATE ROLE rol_almacen;
CREATE ROLE rol_tpvs;
CREATE ROLE rol_admin;

-- 6) Dar USAGE al esquema app (si no, no pueden acceder a objetos del esquema)
GRANT USAGE ON SCHEMA app TO rol_consulta, rol_almacen, rol_tpvs, rol_admin;

-- 7) Permisos sobre tablas seg√∫n rol

-- rol_consulta: solo consultar productos
GRANT SELECT ON app.productos TO rol_consulta;

-- rol_almacen: consultar y actualizar stock
GRANT SELECT, UPDATE ON app.productos TO rol_almacen;

-- rol_tpvs: consultar productos e insertar ventas
GRANT SELECT ON app.productos TO rol_tpvs;
GRANT INSERT, SELECT ON app.ventas TO rol_tpvs;

-- rol_admin: todo sobre tablas del esquema app
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA app TO rol_admin;

-- 8) Permisos sobre secuencias (necesario para INSERT en tablas con SERIAL)
-- Para que TPV y admin puedan insertar sin errores de secuencias
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA app TO rol_tpvs, rol_admin;

-- (Opcional recomendado) Para futuras tablas/secuencias creadas en app:
ALTER DEFAULT PRIVILEGES IN SCHEMA app
GRANT SELECT ON TABLES TO rol_consulta;

ALTER DEFAULT PRIVILEGES IN SCHEMA app
GRANT SELECT, UPDATE ON TABLES TO rol_almacen;

ALTER DEFAULT PRIVILEGES IN SCHEMA app
GRANT SELECT, INSERT ON TABLES TO rol_tpvs;

ALTER DEFAULT PRIVILEGES IN SCHEMA app
GRANT ALL PRIVILEGES ON TABLES TO rol_admin;

ALTER DEFAULT PRIVILEGES IN SCHEMA app
GRANT USAGE, SELECT ON SEQUENCES TO rol_tpvs;

ALTER DEFAULT PRIVILEGES IN SCHEMA app
GRANT USAGE, SELECT ON SEQUENCES TO rol_admin;

-- 9) Crear usuarios
CREATE USER user_consulta WITH PASSWORD '1234';
CREATE USER user_almacen  WITH PASSWORD '1234';
CREATE USER user_tpvs     WITH PASSWORD '1234';
CREATE USER user_admin    WITH PASSWORD '1234';

-- 10) Asignar roles a usuarios
GRANT rol_consulta TO user_consulta;
GRANT rol_almacen  TO user_almacen;
GRANT rol_tpvs     TO user_tpvs;
GRANT rol_admin    TO user_admin;

-- 11) Verificaci√≥n r√°pida (qui√©n tiene qu√©)
-- (En psql tambi√©n puedes usar \du y \dp)
