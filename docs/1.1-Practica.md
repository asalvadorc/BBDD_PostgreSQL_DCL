# üõí PR√ÅCTICA DCL POSTGRESQL

## Gesti√≥n de usuarios, roles y permisos

En esta pr√°ctica vas a dise√±ar un sistema de control de acceso para una base de datos de una tienda utilizando **roles** y **permisos** en PostgreSQL.

El objetivo es que cada tipo de usuario solo pueda realizar las operaciones que le correspondan seg√∫n su funci√≥n.

---

# üéØ Objetivos

- Crear una base de datos con un esquema propio
- Gestionar roles como grupos de permisos
- Asignar permisos sobre tablas
- Asociar usuarios a roles
- Comprobar que cada usuario solo puede hacer lo que le corresponde

---

# üß± 1. Crear la base de datos

Crea una base de datos llamada: tienda


---

# üìÅ 2. Crear un esquema propio

Crea un esquema llamado: app


---

# üîí 3. Seguridad b√°sica

Impide que cualquier usuario pueda crear objetos en el esquema `public`.

---

# üì¶ 4. Crear las tablas

Dentro del esquema `app`, crea:

### Tabla productos

Debe contener:

- id
- nombre
- stock

### Tabla ventas

Debe contener:

- id
- producto_id
- unidades
- fecha

---

# üë• 5. Crear los roles (grupos)

Crea los siguientes roles:

- rol_consulta
- rol_almacen
- rol_tpvs
- rol_admin

---

# üîë 6. Permitir acceso al esquema

Todos los roles deben poder acceder al esquema `app`.

---

# üõ†Ô∏è 7. Asignar permisos seg√∫n funci√≥n

Cada rol debe tener los siguientes permisos:

### üîç rol_consulta

- Solo puede consultar productos

---

### üì¶ rol_almacen

- Puede consultar productos
- Puede actualizar el stock

---

### üõí rol_tpvs

- Puede consultar productos
- Puede registrar ventas

---

### üëë rol_admin

- Debe tener control total sobre las tablas del esquema

---

# üîÑ 8. Secuencias

Aseg√∫rate de que los roles que insertan datos puedan usar las secuencias necesarias.

---

# üë§ 9. Crear usuarios

Crea los siguientes usuarios:

- user_consulta
- user_almacen
- user_tpvs
- user_admin

---

# üîó 10. Asociar usuarios a roles

Cada usuario debe pertenecer a su rol correspondiente.

---

# üß™ 11. Pruebas

Comprueba el comportamiento conect√°ndote como cada usuario.

---

## üîç user_consulta

Debe poder:

- Consultar productos

No debe poder:

- Modificar stock
- Insertar ventas

---

## üì¶ user_almacen

Debe poder:

- Consultar productos
- Actualizar stock

No debe poder:

- Registrar ventas

---

## üõí user_tpvs

Debe poder:

- Consultar productos
- Insertar ventas

No debe poder:

- Modificar stock

---

## üëë user_admin

Debe poder:

- Consultar
- Insertar
- Modificar
- Borrar

---

# üïµÔ∏è 12. Usuario auditor (opcional)

Crea un usuario que:

- No pertenezca a ning√∫n rol creado
- Pueda leer todos los datos
- No pueda modificarlos

---

# üß∞ 13. Verificaci√≥n

Comprueba los permisos existentes sobre las tablas.

---

# üß† Reflexi√≥n final

Responde:

> ¬øQu√© ventaja tiene asignar permisos a roles en lugar de a usuarios?





# üõí PR√ÅCTICA DCL POSTGRESQL (SOLUCI√ìN)



## BD: tienda | Esquema: app

---

## 1) Crear base de datos

    ```sql
    CREATE DATABASE tienda;
    ```

---

## 2) Crear esquema propio

    ```sql
    CREATE SCHEMA app;
    ```

---

## 3) Bloquear creaci√≥n en public

    ```sql
    REVOKE CREATE ON SCHEMA public FROM PUBLIC;
    ```

---

## 4) Crear tablas

    ```sql
    CREATE TABLE app.productos (
        id SERIAL PRIMARY KEY,
        nombre VARCHAR(50) NOT NULL,
        stock INT NOT NULL DEFAULT 0
    );

    CREATE TABLE app.ventas (
        id SERIAL PRIMARY KEY,
        producto_id INT NOT NULL REFERENCES app.productos(id),
        unidades INT NOT NULL,
        fecha TIMESTAMP NOT NULL DEFAULT NOW()
    );
    ```

Datos de prueba:

    ```sql
    INSERT INTO app.productos (nombre, stock) VALUES
    ('Teclado', 20),
    ('Raton', 15);
    ```

---

## 5) Crear roles

    ```sql
    CREATE ROLE rol_consulta;
    CREATE ROLE rol_almacen;
    CREATE ROLE rol_tpvs;
    CREATE ROLE rol_admin;
    ```

---

## 6) Acceso al esquema

    ```sql
    GRANT USAGE ON SCHEMA app TO rol_consulta, rol_almacen, rol_tpvs, rol_admin;
    ```

---

## 7) Permisos

    ```sql
    GRANT SELECT ON app.productos TO rol_consulta;
    GRANT SELECT, UPDATE ON app.productos TO rol_almacen;
    GRANT SELECT ON app.productos TO rol_tpvs;
    GRANT INSERT, SELECT ON app.ventas TO rol_tpvs;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA app TO rol_admin;
    ```

---

## 8) Secuencias

    ```sql
    GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA app TO rol_tpvs, rol_admin;
    ```

---

## 9) Usuarios

    ```sql
    CREATE USER user_consulta WITH PASSWORD '1234';
    CREATE USER user_almacen  WITH PASSWORD '1234';
    CREATE USER user_tpvs     WITH PASSWORD '1234';
    CREATE USER user_admin    WITH PASSWORD '1234';
    ```

---

## 10) Asignar roles

    ```sql
    GRANT rol_consulta TO user_consulta;
    GRANT rol_almacen  TO user_almacen;
    GRANT rol_tpvs     TO user_tpvs;
    GRANT rol_admin    TO user_admin;
    ```

---

## 11) Revocar ejemplo

    ```sql
    REVOKE rol_almacen FROM user_almacen;
    GRANT rol_almacen TO user_almacen;
    ```

---

## 12) Auditor

    ```sql
    CREATE USER user_auditor WITH PASSWORD '1234';
    GRANT CONNECT ON DATABASE tienda TO user_auditor;
    GRANT pg_read_all_data TO user_auditor;
    ```

---

# PRUEBAS

## Conexi√≥n

    ```sql
    GRANT CONNECT ON DATABASE tienda TO
    user_consulta,
    user_almacen,
    user_tpvs,
    user_admin;
    ```

---

## user_consulta

    ```sql
    SELECT * FROM app.productos;
    ```

Debe fallar:

    ```sql
    UPDATE app.productos SET stock = 10 WHERE id = 1;
    INSERT INTO app.ventas (producto_id, unidades) VALUES (1,2);
    ```

---

## user_almacen

    ```sql
    SELECT * FROM app.productos;
    UPDATE app.productos SET stock = stock + 5 WHERE id = 1;
    ```

Debe fallar:

    ```sql
    INSERT INTO app.ventas (producto_id, unidades) VALUES (1,2);
    ```

---

## user_tpvs

    ```sql
    SELECT * FROM app.productos;
    INSERT INTO app.ventas (producto_id, unidades) VALUES (1,3);
    ```

Debe fallar:

    ```sql
    UPDATE app.productos SET stock = 5 WHERE id = 1;
    ```

---

## user_auditor

    ```sql
    SELECT * FROM app.productos;
    SELECT * FROM app.ventas;
    ```

Debe fallar:

    ```sql
    UPDATE app.productos SET stock = 99 WHERE id = 1;
    ```

---

## user_admin

    ```sql
    SELECT * FROM app.productos;
    UPDATE app.productos SET stock = 99 WHERE id = 1;
    INSERT INTO app.ventas (producto_id, unidades) VALUES (1,1);
    DELETE FROM app.ventas WHERE id = 1;
    ```

---

## Ver permisos

    ```sql
    SELECT
    r.rolname,
    ARRAY(SELECT b.rolname
    FROM pg_catalog.pg_auth_members m
    JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
    WHERE m.member = r.oid ) as memberof
    FROM pg_catalog.pg_roles r
    ORDER BY 1;
    ```
